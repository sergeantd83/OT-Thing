<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html>

<head>
    <title>OTthing OpenTherm controller</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        * {
            margin: 0;
            padding: 0;
        }

        body {
            background-color: #210;
            color: #fd975a;
            font-family: sans-serif;
        }

        #mainwrapper {
            max-width: 400px;
            margin: 0px auto;
            background-color: black;
            padding: 5px;
        }

        h2 {
            background-color: #fd975a;
            color: #000;
            padding: 10px;
        }

        div.nav {
            margin-bottom: 5px;
        }

        div.nav li {
            display: inline-block;
            list-style-type: none;
            padding: 5px;
            border-bottom-left-radius: 4px;
            border-bottom-right-radius: 4px;
        }

        div.nav li,
        div.nav a {
            Color: #fd975a;
            ;
            font-weight: bold;
            font-size: 0.8em;
            text-decoration: None;
        }

        div.nav li:hover {
            background-color: #444;
            cursor: pointer;
        }

        div.nav li.active {
            background-color: #fd975a;
            ;
            color: black;
        }

        div.group {
            border: 2px solid #fd975a;
            border-radius: 6px;
            padding: 5px;
        }

        div.flexline {
            display: flex;
            margin-bottom: 0.4em;
            flex-wrap: wrap;
        }

        div.statusfield {
            min-width: 50%;
            padding-bottom: 0.5em;
        }

        div.param {
            padding-right: 1em;
            padding-bottom: 0.3em;
        }

        h3 {
            font-size: 1.0em;
            border-left: 6px solid #fd975a;
            margin: 0.5em 0 0.5em 0;
            padding-left: 0.5em;
        }

        h4 {
            font-size: 0.85em;
            padding-bottom: 0.3em;
        }

        h5,
        th {
            font-size: 0.7em;
        }

        div.valunit {
            display: inline-block;
            width: 25%;
        }

        .statusvalue {
            color: #fff;
        }

        .statusvalue.bool-ok::before {
            content: "✔";
            color: #080;
        }

        .statusvalue.bool-off::before {
            content: "✖";
            color: #777
        }

        .statusvalue.bool-error::before {
            content: "⚠";
            color: #c00;
        }

        div.param span.value {
            font-size: 1.8em;
            font-weight: bold;
            color: white;
        }

        div.infobox {
            display: none;
            padding: 10px;
            color: #999;
            font-size: 0.9em;
        }

        ul {
            list-style-position: inside;
        }

        input[type=text],
        input[type=password],
        select {
            background-color: #111;
            margin: 5px 0;
            border: 1px solid #fd975a;
            color: #fff;
            padding: 3px;
        }

        input[type=range] {
            -webkit-appearance: none;
            background: #fd975a;
            height: 5px;
            margin: auto 0;
            width: 75%;
            cursor: pointer;
        }

        input[type=radio] {
            margin: 5px 0;
            cursor: pointer;
        }

        div.curve {
            text-align: center;
            background-color: #000;
            margin-bottom: 0.5em;
        }

        div.toolbar {
            text-align: center;
            padding: 0.3em 0;
        }

        button,
        input[type=submit] {
            background-color: #fd975a;
            color: black;
            padding: 0 1em;
            border-radius: 8px;
            border-style: none;
            box-sizing: border-box;
            font-weight: 500;
            height: 30px;
            outline: none;
            touch-action: manipulation;
            cursor: pointer;
            display: inline-block;
        }

        button:focus {
            background-color: #fd975a;
        }

        button:hover {
            background-color: #6d99a4;
        }

        button:active {
            background-color: #4d7984;
        }

        button.pressed {
            border: 1px solid #fd975a;
            background-color: black;
            color: #fd975a;
        }

        button:disabled {
            background-color: #f0c9b0;
            color: #666666;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }

        table {
            width: 100%;
            text-align: left;
        }

        table tbody {
            color: #fff;
            font-size: 0.9em;
        }

        table th.ot, table th.ft, table th.rs {
            width: 15%;
        }

        table th.rem {
            width: 8%;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 28px;
            margin: 5px 0;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #333;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 5px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: #8d5535;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 3px;
        }

        input:checked+.slider {
            background-color: #fd975a;
        }

        input:focus+.slider {
            box-shadow: 0 0 1px #8d5535;
        }

        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        div.footer {
            text-align: center;
            color: #fd975a;
            margin-top: 0.5em;
            padding: 5px;
        }

        div.footer a,
        div.footer a:visited {
            font-size: 0.8em;
            color: #fd975a;
            text-decoration: none;
        }

        #scanHint {
            padding: 5px;
        }

        #stickydiv {
            position: sticky;
            top: 0;
            font-weight: bold;
            text-align: center;
        }

        #nocon {
            padding: 0.6em;
            background-color: #c00;
        }

        #console {
            background-color: black;
            height: 40em;
            color: white;
            resize: vertical;
            overflow: auto;
            padding: 0 0.5em;
        }

        #console div {
            font-family: "Lucida Console", "Courier New", monospace;
            font-size: 12px;
        }

        #logstatus {
            height: 0.5em;
        }

        #logstatus.connected {
            background-color: green;
        }

        #logstatus.disconnected {
            background-color: red;
        }

        #updprogress {
            width: 100%;
        }

        [hidden] {
            display: none !important;
        }

        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .modal.hidden {
            display: none;
        }

        .modal-content {
            background-color: #000;
            border: 2px solid #fd975a;
            border-radius: 8px;
            max-width: 90%;
            width: 360px;
            box-sizing: border-box;
            padding: 8px;
            color: #fff;
            box-shadow: 0 0 20px rgba(253, 151, 90, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #fd975a;
            color: #000;
            padding: 6px 10px;
            border-radius: 6px;
            font-weight: bold;
            font-size: 0.9em;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 10px;
        }

        #modalBody {
            background-color: #000;
            color: #fff;
            border: 1px solid #fd975a;
            border-radius: 6px;
            margin-top: 8px;
            padding: 6px;
            font-family: "Lucida Console", "Courier New", monospace;
            font-size: 0.75em;
            white-space: pre-wrap;
            max-height: 50vh;
            overflow: auto;
        }
    </style>
</head>

<body>
    <div id="stickydiv">
        <div id="nocon" hidden>No connection to device...</div>
    </div>

    <div id="mainwrapper">
        <h2>OTthing</h2>

        <div class="nav">
            <ul>
                <li tab="status" class="active">Status</li>
                <li tab="setup">Setup</li>
                <li tab="heatingcurve1" class="app-heat">Heating circuit 1</li>
                <li tab="heatingcurve2" class="app-heat CH2">Heating circuit 2</li>
                <li tab="log">Log</li>
            </ul>
        </div>

        <div class="tab" id="status">
            <h3>System</h3>
            <div class="group">
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Firmware</h5>
                        <span class="statusvalue" field="fw_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Runtime</h5>
                        <span class="statusvalue" id="runtime"></span>
                    </div>
                    <div class="statusfield">
                        <h5>reset reason</h5>
                        <span class="statusvalue" field="resetInfo"></span>
                    </div>
                    <div class="statusfield">
                        <h5>MAC</h5>
                        <span class="statusvalue" field="wifi.mac"></span>
                    </div>
                    <div class="statusfield">
                        <h5>IP</h5>
                        <span class="statusvalue" field="wifi.ipsta"></span>
                    </div>
                    <div class="statusfield">
                        <h5>SSID</h5>
                        <span class="statusvalue" field="wifi.sta_ssid"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Hostname</h5>
                        <span class="statusvalue" field="wifi.hostname"></span>
                    </div>
                    <div class="statusfield">
                        <h5>MQTT basetopic</h5>
                        <a href="/topics" target="_blank" class="statusvalue" field="mqtt.basetopic"></a>
                    </div>
                    <div class="statusfield">
                        <h5>WiFi status</h5>
                        <span class="statusvalue" field="wifi.status"></span>
                    </div>
                    <div class="statusfield">
                        <h5>RSSI</h5>
                        <span class="statusvalue" field="wifi.rssi" unit="dBm"></span>
                    </div>
                    <div class="statusfield">
                        <h5>WiFi disconnections</h5>
                        <span class="statusvalue" field="numWifiDisc"></span>
                    </div>
                    <div class="statusfield">
                        <h5>MQTT connected</h5>
                        <span class="statusvalue" field="mqtt.connected"></span>
                    </div>
                    <div class="statusfield">
                        <h5>MQTT disconnections</h5>
                        <span class="statusvalue" field="mqtt.numDisc"></span>
                    </div>
                    <div class="statusfield">
                        <h5>USB connected</h5>
                        <span class="statusvalue" field="USB_connected"></span>
                    </div>
                </div>
            </div>
            <div id="owdiv">
                <h3>OpenWeather</h3>
                <div class="group">
                    <h5>Status</h5>
                    <span class="statusvalue" field="owResult"></span>
                </div>
            </div>
            <h3>Slave</h3>
            <div class="group">
                <h4>Status</h4>
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Flame</h5>
                        <span class="statusvalue" field="slave.status.flame"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Diagnostic</h5>
                        <span class="statusvalue error" field="slave.status.diagnostic"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heater circuit 1 active</h5>
                        <span class="statusvalue" field="slave.status.ch_mode"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heater circuit 2 active</h5>
                        <span class="statusvalue" field="slave.status.ch2_mode"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW active</h5>
                        <span class="statusvalue" field="slave.status.dhw_mode"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. fault</h5>
                        <span class="statusvalue error" field="slave.vent_status.fault"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. active</h5>
                        <span class="statusvalue" field="slave.vent_status.vent_active"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. bypass open</h5>
                        <span class="statusvalue" field="slave.vent_status.bypass_open"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. bypass auto</h5>
                        <span class="statusvalue" field="slave.vent_status.bypass_auto"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Free vent.</h5>
                        <span class="statusvalue" field="slave.vent_status.free_vent"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. diagnostic</h5>
                        <span class="statusvalue error" field="slave.vent_status.diagnostic"></span>
                    </div>
                </div>
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Flow temperature</h5>
                        <span class="statusvalue" field="slave.flow_t" unit="&deg;C"></span>
                    </div>
                    
                    <div class="statusfield">
                        <h5>Flow temperature 2</h5>
                        <span class="statusvalue" field="slave.flow_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW temperature</h5>
                        <span class="statusvalue" field="slave.dhw_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW temperature 2</h5>
                        <span class="statusvalue" field="slave.dhw_t2" unit="&deg;C"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Exhaust temperature</h5>
                        <span class="statusvalue" field="slave.exhaust_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Outside temperature</h5>
                        <span class="statusvalue" field="slave.outside_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Return temperature</h5>
                        <span class="statusvalue" field="slave.return_t" unit="&deg;C"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Room override temp.</h5>
                        <span class="statusvalue" field="slave.tr_override" unit="&deg;C"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Supply inlet temp.</h5>
                        <span class="statusvalue" field="slave.supply_inlet_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Supply outlet temp.</h5>
                        <span class="statusvalue" field="slave.supply_outlet_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Exhaut inlet temp.</h5>
                        <span class="statusvalue" field="slave.exhaust_inlet_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Exhaut outlet temp.</h5>
                        <span class="statusvalue" field="slave.exhaust_outlet_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heat exchanger temp.</h5>
                        <span class="statusvalue" field="slave.boiler_heat_ex_t" unit="°C"></span>
                    </div>
                </div>
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Modulation</h5>
                        <span class="statusvalue" field="slave.rel_mod" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Rel. ventilation</h5>
                        <span class="statusvalue" field="slave.rel_vent" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>flame ratio (3 h)</h5>
                        <span class="statusvalue" field="slave.flameRatio" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW flow rate</h5>
                        <span class="statusvalue" field="slave.dhw_flow_rate" unit="l/min"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Pressure</h5>
                        <span class="statusvalue" field="slave.ch_pressure" unit="bar"></span>
                    </div>                    
                    <div class="statusfield">
                        <h5>burner op. hours</h5>
                        <span class="statusvalue" field="slave.burner_op_hours" unit="h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW burner op. hours</h5>
                        <span class="statusvalue" field="slave.dhw_burner_op_hours" unit="h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>CH pump op. hours</h5>
                        <span class="statusvalue" field="slave.chpump_op_hours" unit="h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW pump/valve op. hours</h5>
                        <span class="statusvalue" field="slave.dhwpump_op_hours" unit="h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Burner starts</h5>
                        <span class="statusvalue" field="slave.burner_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>DHW Burner starts</h5>
                        <span class="statusvalue" field="slave.dhw_burner_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Unsuccessful burner starts</h5>
                        <span class="statusvalue" field="slave.unsuccessful_burner_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>CH pump starts</h5>
                        <span class="statusvalue" field="slave.ch_pump_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>DHW pump starts</h5>
                        <span class="statusvalue" field="slave.dhw_pump_starts"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Number flame signal low</h5>
                        <span class="statusvalue" field="slave.num_flame_signal_low"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Power cycles</h5>
                        <span class="statusvalue" field="slave.power_cycles"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Num. TSPs</h5>
                        <span class="statusvalue" field="slave.num_tsps"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Size fault hist. buffer</h5>
                        <span class="statusvalue" field="slave.size_fhb"></span>    
                    </div>
                    <div class="statusfield">
                        <h5>Boiler fanspeed setpoint</h5>
                        <span class="statusvalue" field="slave.boiler_fan.setpoint" unit="Hz"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Boiler fanspeed actual</h5>
                        <span class="statusvalue" field="slave.boiler_fan.actual" unit="Hz"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flame current</h5>
                        <span class="statusvalue" field="slave.flame_current" unit="µA"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OEM fault code</h5>
                        <span class="statusvalue" field="slave.fault_flags.oem_fault_code"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OEM diagnostic code</h5>
                        <span class="statusvalue" field="slave.oem_diag_code"></span>
                    </div>
                    <div class="statusfield">
                        <h5>CO2 exhaust</h5>
                        <span class="statusvalue" field="slave.co2_exhaust" unit="ppm"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Exhaust fan speed</h5>
                        <span class="statusvalue" field="slave.exhaust_fan_speed" unit="rpm"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Supply fan speed</h5>
                        <span class="statusvalue" field="slave.supply_fan_speed" unit="rpm"></span>
                    </div>
                    <div class="statusfield">
                        <h5>burner starts (3 h)</h5>
                        <span class="statusvalue" field="slave.flameFreq" unit="/h"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames sent</h5>
                        <span class="statusvalue" field="slave.txCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames received</h5>
                        <span class="statusvalue" field="slave.rxCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames timeouts</h5>
                        <span class="statusvalue" field="slave.timeouts"></span>
                    </div>
                </div>
                <h4>configuration</h4>
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Ctrl-type on/off</h5>
                        <span class="statusvalue" field="slave.slave_config_member.ctrl_type"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW present</h5>
                        <span class="statusvalue" field="slave.slave_config_member.dhw_present"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Master low-off/pump-ctrl n. a.</h5>
                        <span class="statusvalue" field="slave.slave_config_member.master_lowoff_pumpctrl"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW storage tank</h5>
                        <span class="statusvalue" field="slave.slave_config_member.dhw_config"></span>
                    </div>
                    <div class="statusfield">
                        <h5>CH2 present</h5>
                        <span class="statusvalue" field="slave.slave_config_member.ch2_present"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW setpoint trans.</h5>
                        <span class="statusvalue" field="slave.rp_flags.dhw_setpoint_trans"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. CH setpoint trans.</h5>
                        <span class="statusvalue" field="slave.rp_flags.max_ch_setpoint_trans"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW setpoint R/W</h5>
                        <span class="statusvalue" field="slave.rp_flags.dhw_setpoint_rw"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. CH setpoint R/W</h5>
                        <span class="statusvalue" field="slave.rp_flags.max_ch_setpoint_rw"></span>
                    </div>
                </div>
                <div class="flexline">
                    <div class="statusfield">
                        <h5>DHW min. temperature</h5>
                        <span class="statusvalue" field="slave.dhw_bounds.min" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW max. temperature</h5>
                        <span class="statusvalue" field="slave.dhw_bounds.max" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Min. flow temperature</h5>
                        <span class="statusvalue" field="slave.ch_bounds.min" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. flow temperature</h5>
                        <span class="statusvalue" field="slave.ch_bounds.max" unit="&deg;C"></span>
                    </div>
                </div>
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Max. capacity</h5>
                        <span class="statusvalue" field="slave.max_cap_min_mod.max_capacity" unit="kW"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Min. modulation level</h5>
                        <span class="statusvalue" field="slave.max_cap_min_mod.min_modulation" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Product version</h5>
                        <span class="statusvalue" field="slave.slave_prod_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OT version</h5>
                        <span class="statusvalue" field="slave.slave_ot_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. product version</h5>
                        <span class="statusvalue" field="slave.vent_prod_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>vent. OT version</h5>
                        <span class="statusvalue" field="slave.vent_ot_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Member ID</h5>
                        <span class="statusvalue" field="slave.slave_config_member.memberId"></span>
                    </div>
                    <div class="statusfield">
                        <h5>brand</h5>
                        <span class="statusvalue" field="slave.brand"></span>
                    </div>
                    <div class="statusfield">
                        <h5>brand version</h5>
                        <span class="statusvalue" field="slave.brand_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>brand serial number</h5>
                        <span class="statusvalue" field="slave.brand_serial"></span>
                    </div>
                </div>
            </div>

            <h3>Master</h3>
            <div class="group">
                <div class="flexline">
                    <div class="statusfield">
                        <h5>Heater circuit 1 enabled</h5>
                        <span class="statusvalue" field="thermostat.status.ch_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Heater circuit 2 enabled</h5>
                        <span class="statusvalue" field="thermostat.status.ch2_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW enabled</h5>
                        <span class="statusvalue" field="thermostat.status.dhw_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Outside temp. compensation</h5>
                        <span class="statusvalue" field="thermostat.status.otc_active"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flow set temperature</h5>
                        <span class="statusvalue" field="thermostat.ch_set_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Flow set temperature 2</h5>
                        <span class="statusvalue" field="thermostat.ch_set_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>DHW set temperature</h5>
                        <span class="statusvalue" field="thermostat.dhw_set_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room temperature</h5>
                        <span class="statusvalue" field="thermostat.room_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room set temperature</h5>
                        <span class="statusvalue" field="thermostat.room_set_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room temperature 2</h5>
                        <span class="statusvalue" field="thermostat.room_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Room set temperature 2</h5>
                        <span class="statusvalue" field="thermostat.room_set_t2" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>outside temp.</h5>
                        <span class="statusvalue" field="thermostat.outside_t" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Max. rel. modulation</h5>
                        <span class="statusvalue" field="thermostat.max_rel_mod" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Product version</h5>
                        <span class="statusvalue" field="thermostat.master_prod_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>OT version</h5>
                        <span class="statusvalue" field="thermostat.master_ot_version"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Member ID</h5>
                        <span class="statusvalue" field="thermostat.master_config_member.memberId"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Smart power</h5>
                        <span class="statusvalue" field="thermostat.smartPower"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Smart power implemented</h5>
                        <span class="statusvalue" field="thermostat.master_config_member.smartPowerImplemented"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames sent</h5>
                        <span class="statusvalue" field="thermostat.txCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Frames received</h5>
                        <span class="statusvalue" field="thermostat.rxCount"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Ventilation set point</h5>
                        <span class="statusvalue" field="thermostat.rel_vent_set" unit="%"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. enable</h5>
                        <span class="statusvalue" field="thermostat.vent_status.vent_enable"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. open bypass</h5>
                        <span class="statusvalue" field="thermostat.vent_status.open_bypass"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Vent. bypass auto</h5>
                        <span class="statusvalue" field="thermostat.vent_status.auto_bypass"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Free vent. enable</h5>
                        <span class="statusvalue" field="thermostat.vent_status.free_vent_enable"></span>
                    </div>
                </div>
            </div>

            <h3>1-wire</h3>
            <div class="group">
                <div class="flexline" id="oneWireSensors">
                </div>
            </div>

            <h3>BLE</h3>
            <div id="bleSensors" class="group">
            </div>
        </div>

        <div class="tab" id="heatingcurve1">
            <h3>Dimensioning</h3>
            <div class="group">
                <div id="flowmax1" class="param">
                    <h5>Max. flow temperature</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="30" max="90" step="1">
                    </div>
                    <div class="infobox">
                        Gängige Systemtemperaturen Vorlauf/R&uuml;cklauf:
                        <ul>
                            <li>Alte Norm: 90 &deg;C / 70 &deg;C</li>
                            <li>Neue Norm: 75 &deg;C / 65 &deg;C</li>
                            <li>Niedertemperatur: 70 &deg;C / 50 &deg;C</li>
                            <li>Brennwert: 60 &deg;C / 45 &deg;C</li>
                            <li>Brennwert: 45 &deg;C / 35 &deg;C</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>

                <div id="exponent1" class="param">
                    <h5>Heating surface exponent</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="1.0" max="1.5" step="0.05">
                    </div>
                    <div class="infobox">
                        Je nach Anteil von Leitung, Konvektion und Strahlung ist das Verhältnis von Vorlauftemperatur
                        und
                        Wärmeabgabe überliniear:
                        <ul>
                            <li>Fußbodenheizung: 1,0 - 1,05</li>
                            <li>Flachheizkörper: 1,26 - 1,33</li>
                            <li>Handtuchradiatoren: 1,20 - 1,30</li>
                            <li>Heizkörper nach DIN 4703: 1,3</li>
                            <li>Konvektoren: 1,30 - 1,50</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>
            </div>

            <h3>Setup</h3>
            <div class="group">
                <div id="chset1" class="param">
                    <h5>flow set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="25" max="90" step="1" />
                    </div>
                </div>

                <div id="roomset1" class="param">
                    <h5>Room set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="17" max="23" step="0.1">
                    </div>
                </div>

                <div class="param">
                    <h5>Room setpoint source</h5>
                    <select id="selectRoomSetpointSource1" field="heating.0.roomsetpoint.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                        <option value="5">auto</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomSetpoint1/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                    <div class="selopt">
                    </div>
                </div>
                <div class="param">
                    <h5>Current room temperature source</h5>
                    <select id="selectRoomTempSource1" field="heating.0.roomtemp.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                        <option value="2">Bluetooth</option>
                        <option value="3">1wire</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomTemp1/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <input id="bleRoomTempAdr1" type="text" />
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <select id="oneWireRoomTempAdr1" class="oneWireAdr">
                        </select>
                    </div>
                </div>

                <h4>Room compensation (PI controller)</h4>
                <div class="param">
                    <h5>enable</h5>
                    <div>
                        <label class="switch">
                            <input id="roomCompEnable1" type="checkbox" hideele="roomCompP1 roomCompI1 roomCompBoost1" />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="roomCompP1" class="param">
                    <h5>P gain</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">K/K</span>
                        </div>
                        <input type="range" min="0" max="4" step="0.1">
                    </div>
                </div>
                <div id="roomCompI1" class="param">
                    <h5>I gain</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">1/h</span>
                        </div>
                        <input type="range" min="0" max="1" step="0.1">
                    </div>
                </div>
                <div id="roomCompBoost1" class="param">
                    <h5>Boost</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">K/K</span>
                        </div>
                        <input type="range" min="0" max="4" step="0.1">
                    </div>
                </div>

                <h4>Suspend on room setpoint</h4>
                <div class="param">
                    <h5>enable</h5>
                    <div>
                        <label class="switch">
                            <input id="enableHyst1" type="checkbox" hideele="hyst1" />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="hyst1" class="param">
                    <h5>hysteresis</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">K</span>
                        </div>
                        <input type="range" min="0.1" max="2" step="0.1">
                    </div>
                </div>
            </div>

            <h3 style="display: none">Scheduler</h3>
            <div class="group" style="display: none">
                <table>
                    <thead>
                        <tr>
                            <th class="days">days</th>
                            <th class="time">time</th>
                            <th class="ft">room set temperature</th>
                            <th class="rem"></th>
                        </tr>
                    </thead>
                    <tbody id="schedulerbody1">
                    </tbody>
                </table>
                <button id="addscheduler1" channel="1">+</button>
            </div>

            <h3>Heating curve</h3>
            <div class="group">
                <div id="gradient1" class="param">
                    <h5>Gradient</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="0.1" max="3" step="0.05">
                    </div>
                    <div class="infobox">
                        <p>
                            Quelle: <a href="http://www.bosy-online.de/Heizkurve.htm">www.bosy-online.de</a>
                        </p>
                    </div>
                </div>

                <div id="offset1" class="param">
                    <h5>Offset</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="-15" max="15" step="0.5">
                    </div>
                </div>

                <div class="curve">
                    <canvas id="canvas1" height="375px" width="375px">
                    </canvas>
                </div>

                <div class="flexline">
                    <div class="statusfield nohide">
                        <h5>Outside temperature</h5>
                        <span class="statusvalue" field="outsideTemp" unit="°C"></span>
                    </div>
                    <div class="statusfield nohide">
                        <h5>Room set point</h5>
                        <span class="statusvalue" field="heatercircuit.0.roomsetpoint" unit="°C"></span>
                    </div>
                    <div class="statusfield nohide">
                        <h5>Room temperature</h5>
                        <span class="statusvalue" field="heatercircuit.0.roomtemp" unit="&deg;C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Suspended</h5>
                        <span class="statusvalue" field="heatercircuit.0.suspended"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Integrator state</h5>
                        <span class="statusvalue" field="heatercircuit.0.integState" unit="K"></span>
                    </div>
                </div>
            </div>

            <h3>Marker</h3>
            <div class="group">
                <table>
                    <thead>
                        <tr>
                            <th class="comment">comment</th>
                            <th class="rs">roomset</th>
                            <th class="ot">outside</th>
                            <th class="ft">flow</th>
                            <th class="rem"></th>
                        </tr>
                    </thead>
                    <tbody id="markerbody1">
                    </tbody>
                </table>
                <input type="text" id="comment1" />
                <button id="addmarker1">+</button>
            </div>
        </div>

        <div class="tab" id="heatingcurve2">
            <h3>Dimensioning</h3>
            <div class="group">
                <div id="flowmax2" class="param">
                    <h5>Max. flow temperature</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="30" max="90" step="1">
                    </div>
                    <div class="infobox">
                        Gängige Systemtemperaturen Vorlauf/R&uuml;cklauf:
                        <ul>
                            <li>Alte Norm: 90 &deg;C / 70 &deg;C</li>
                            <li>Neue Norm: 75 &deg;C / 65 &deg;C</li>
                            <li>Niedertemperatur: 70 &deg;C / 50 &deg;C</li>
                            <li>Brennwert: 60 &deg;C / 45 &deg;C</li>
                            <li>Brennwert: 45 &deg;C / 35 &deg;C</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>

                <div id="exponent2" class="param">
                    <h5>Heating surface exponent</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="1.0" max="1.5" step="0.05">
                    </div>
                    <div class="infobox">
                        Je nach Anteil von Leitung, Konvektion und Strahlung ist das Verhältnis von Vorlauftemperatur und Wärmeabgabe überlinear:
                        <ul>
                            <li>Fußbodenheizung: 1,0 - 1,05</li>
                            <li>Flachheizkörper: 1,26 - 1,33</li>
                            <li>Handtuchradiatoren: 1,20 - 1,30</li>
                            <li>Heizkörper nach DIN 4703: 1,3</li>
                            <li>Konvektoren: 1,30 - 1,50</li>
                        </ul>
                        <p>Quelle: <a href="www.bosy-online.de">www.bosy-online.de</a></p>
                    </div>
                </div>
            </div>

            <h3>Setup</h3>
            <div class="group">
                <div id="chset2" class="param">
                    <h5>flow set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="25" max="90" step="1" />
                    </div>
                </div>

                <div id="roomset2" class="param">
                    <h5>Room set temperature (default)</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="17" max="23" step="0.1">
                    </div>
                    <div class="infobox">
                    </div>
                </div>
                <div class="param">
                    <h5>Room setpoint source</h5>
                    <select id="selectRoomSetpointSource2" field="heating.1.roomsetpoint.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                        <option value="5">auto</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomSetpoint2/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                    <div class="selopt">
                    </div>
                </div>
                <div class="param">
                    <h5>Current room temperature source</h5>
                    <select id="selectRoomTempSource2" field="heating.1.roomtemp.source">
                        <option value="0">MQTT</option>
                        <option value="1">OT roomunit</option>
                        <option value="2">Bluetooth</option>
                        <option value="3">1wire</option>
                    </select>
                    <div class="selopt">
                        <h5>Topic</h5>
                        <div class="statusfield statusvalue">
                            <span class="mqttbasetopic"></span><span>/roomTemp2/set</span>
                        </div>
                    </div>
                    <div class="selopt">
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <input id="bleRoomTempAdr2" type="text" />
                    </div>
                    <div class="selopt">
                        <h5>address</h5>
                        <select id="oneWireRoomTempAdr2" class="oneWireAdr">
                        </select>
                    </div>
                </div>
                <h4>Room compensation (PI controller)</h4>
                <div class="param">
                    <h5>enable</h5>
                    <div>
                        <label class="switch">
                            <input id="roomCompEnable2" type="checkbox" hideele="roomCompP2 roomCompI2 roomCompBoost2" />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="roomCompP2" class="param">
                    <h5>P gain</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">K/K</span>
                        </div>
                        <input type="range" min="0" max="5" step="0.1">
                    </div>
                </div>
                <div id="roomCompI2" class="param">
                    <h5>I gain</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">1/h</span>
                        </div>
                        <input type="range" min="0" max="1" step="0.1">
                    </div>
                </div>

                <div id="roomCompBoost2" class="param">
                    <h5>Boost</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">K/K</span>
                        </div>
                        <input type="range" min="0" max="4" step="0.1">
                    </div>
                </div>

                <h4>Suspend on room setpoint</h4>
                <div class="param">
                    <h5>enable</h5>
                    <div>
                        <label class="switch">
                            <input id="enableHyst2" type="checkbox" hideele="hyst2" />
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                <div id="hyst2" class="param">
                    <h5>hysteresis</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">K</span>
                        </div>
                        <input type="range" min="0.1" max="2" step="0.1">
                    </div>
                </div>
            </div>

            <h3>Heating curve</h3>
            <div class="group">
                <div id="gradient2" class="param">
                    <h5>Gradient</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                        </div>
                        <input type="range" min="0.1" max="3" step="0.05">
                    </div>
                    <div class="infobox">
                        <p>
                            Quelle: <a href="http://www.bosy-online.de/Heizkurve.htm">www.bosy-online.de</a>
                        </p>
                    </div>
                </div>

                <div id="offset2" class="param">
                    <h5>Offset</h5>
                    <div class="flexline">
                        <div class="valunit">
                            <span class="value"></span>
                            <span class="unit">&deg;C</span>
                        </div>
                        <input type="range" min="-15" max="15" step="0.5">
                    </div>
                </div>

                <div class="curve">
                    <canvas id="canvas2" height="375px" width="375px">
                    </canvas>
                </div>

                <div class="flexline">
                    <div class="statusfield nohide">
                        <h5>Outside temperature</h5>
                        <span class="statusvalue" field="outsideTemp" unit="°C"></span>
                    </div>
                    <div class="statusfield nohide">
                        <h5>Room set point</h5>
                        <span class="statusvalue" field="heatercircuit.1.roomsetpoint" unit="°C"></span>
                    </div>
                    <div class="statusfield nohide">
                        <h5>Room temperature</h5>
                        <span class="statusvalue" field="heatercircuit.1.roomtemp" unit="°C"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Suspended</h5>
                        <span class="statusvalue" field="heatercircuit.1.suspended"></span>
                    </div>
                    <div class="statusfield">
                        <h5>Integrator state</h5>
                        <span class="statusvalue" field="heatercircuit.1.integState" unit="K"></span>
                    </div>
                </div>
            </div>

            <h3>Marker</h3>
            <div class="group">
                <table>
                    <thead>
                        <tr>
                            <th class="comment">comment</th>
                            <th class="ot">outside</th>
                            <th class="ft">flow</th>
                            <th class="rem"></th>
                        </tr>
                    </thead>
                    <tbody id="markerbody2">
                    </tbody>
                </table>
                <input type="text" id="comment2" />
                <button id="addmarker2">+</button>
            </div>
        </div>

        <div class="tab" id="setup">
            <h3>WiFi</h3>
            <div class="group">
                <div class="flexline">
                    <div class="param">
                        <h5>Hostname</h5>
                        <input id="hostname" type="text" value="otthing" />
                    </div>
                </div>
                <button id="scan">scan</button><span id="scanHint" hidden>Scan running...</span>
                <div id="scanResults" hidden>
                    <table>
                        <thead>
                            <tr>
                                <th></th>
                                <th>SSID</th>
                                <th>channel</th>
                                <th>RSSI</th>
                            </tr>
                        </thead>
                        <tbody id="scanbody">
                        </tbody>
                    </table>
                    <h5>SSID</h5>
                    <input id="wifissid" type="text"/>
                    <h5>Passwort</h5>
                    <input id="wifipass" type="password"/>
                    <div><button id="btnsavewifi">connect</button></div>
                </div>
            </div>

            <h3>OpenTherm</h3>
            <div class="group">
                <h4>Mode</h4>
                <div class="flexline">
                    <div class="param">
                        <input type="radio" name="otMode" value="0">
                        <label>Bypass</label>
                    </div>
                    <div class="param">
                        <input type="radio" name="otMode" value="1">
                        <label>Master</label>
                    </div>
                    <div class="param">
                        <input type="radio" name="otMode" value="2">
                        <label>Repeater</label>
                    </div>
                    <div class="param" style="display: block">
                        <input type="radio" name="otMode" value="4">
                        <label>Test</label>
                    </div>
                </div>
                <div class="param otmode-master">
                    <h5>Enable slave interface</h5>
                    <label class="switch">
                        <input id="enableslave" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="param">
                    <h5>Slave application</h5>
                    <select id="slaveapp">
                        <option value="0">heat/cool</option>
                        <option value="1">ventilation</option>
                    </select>
                </div>

                <div class="app-heat">
                    <h4>heat/cool</h4>
                    <div class="flexline">
                        <div class="param">
                            <h5>Circuit 1</h5>
                            <label class="switch">
                                <input id="chOn1" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param CH2">
                            <h5>Circuit 2</h5>
                            <label class="switch">
                                <input id="chOn2" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param cool">
                            <h5>Cooling</h5>
                            <label class="switch">
                                <input id="coolOn" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param DHW">
                            <h5>DHW</h5>
                            <label class="switch">
                                <input id="dhwOn" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>OTC</h5>
                            <label class="switch">
                                <input id="otc" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>summer mode</h5>
                            <label class="switch">
                                <input id="summerMode" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param DHW">
                            <h5>DHW blocking</h5>
                            <label class="switch">
                                <input id="dhwBlocking" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div id="maxModulation" class="param">
                        <h5>Max. modulation</h5>
                        <div class="flexline">
                            <div class="valunit">
                                <span class="value"></span>
                                <span class="unit">%</span>
                            </div>
                            <input type="range" min="0" max="100" step="1" />
                        </div>
                    </div>
                    <div id="dhwtemp" class="param DHW">
                        <h5>DHW set temperature</h5>
                        <div class="flexline">
                            <div class="valunit">
                                <span class="value"></span>
                                <span class="unit">&deg;C</span>
                            </div>
                            <input type="range" min="30" max="70" step="1" />
                        </div>
                    </div>
                </div>

                <div class="app-vent">
                    <h4>ventilation</h4>
                    <div class="flexline">
                        <div class="param">
                            <h5>vent. enable</h5>
                            <label class="switch">
                                <input id="ventEnable" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>open bypass</h5>
                            <label class="switch">
                                <input id="openBypass" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>auto bypass</h5>
                            <label class="switch">
                                <input id="autoBypass" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>free vent. enable</h5>
                            <label class="switch">
                                <input id="freeVentEnable" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                    <div id="ventsetpoint" class="param">
                        <h5>ventilation set point</h5>
                        <div class="flexline">
                            <div class="valunit">
                                <span class="value"></span>
                                <span class="unit">%</span>
                            </div>
                            <input type="range" min="0" max="100" step="1" />
                        </div>
                    </div>
                </div>
                <div>
                    <div class="param">
                        <h5>Member ID</h5>
                        <input id="masterMemberId" type="text" />
                    </div>
                </div>
                <div>
                    <h4>override values</h4>
                    <div class="flexline">
                        <div class="param">
                            <h5>flow temp. 1</h5>
                            <label class="switch">
                                <input id="overrideFlow1" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param CH2">
                            <h5>flow temp. 2</h5>
                            <label class="switch">
                                <input id="overrideFlow2" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div class="param">
                            <h5>DHW set temp</h5>
                            <label class="switch">
                                <input id="overrideDhw" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="otmode-master">
                    <h4>Requests</h4>
                    <div>
                        <select id="selRequest">
                            <option value="0000" selected>back to normal operation</option>
                            <option value="0100">boiler lockout reset</option>
                            <option value="0200">CH water filling</option>
                            <option value="0300">service mode max. power</option>
                            <option value="0400">service mode min. power</option>
                            <option value="0500">service mode spark test</option>
                            <option value="0600">service mode fan max.</option>
                            <option value="0700">service mode fan min.</option>
                            <option value="0800">service mode 3-way valve to CH</option>
                            <option value="0900">service mode 3-way valve to DHW</option>
                            <option value="0a00">reset service mode flag</option>
                            <option value="0c00">automatic hydronic air purge</option>
                        </select>
                        <button id="btnRequest">send</button>
                    </div>
                </div>
            </div>

            <h3>MQTT</h3>
            <div class="group">
                <div class="flexline">
                    <div class="param">
                        <h5>Host</h5>
                        <input id="mqttHost" type="text" />
                    </div>
                    <div class="param">
                        <h5>Port</h5>
                        <input id="mqttPort" type="text" />
                    </div>
                    <div class="param">
                        <h5>Keep alive</h5>
                        <input id="mqttKeepAlive" type="text" value="15"/>
                    </div>
                    <div class="param">
                        <h5>HA disc. prefix</h5>
                        <input id="haPrefix" type="text" />
                    </div>
                    <div class="param">
                        <h5>HA device name</h5>
                        <input id="haName" type="text" />
                    </div>
                    <div class="param">
                        <h5>TLS</h5>
                        <div>
                            <label class="switch">
                                <input id="mqttTls" type="checkbox" />
                                <span class="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="flexline">
                    <div class="param">
                        <h5>Username</h5>
                        <input id="mqttUser" type="text" />
                    </div>
                    <div class="param">
                        <h5>Password</h5>
                        <input id="mqttPass" type="password" />
                    </div>
                </div>                
            </div>

            <h3>Outside temperature</h3>
            <div class="group">
                <h5>Source</h5>
                <select id="selectOutsideTempSource" field="outsideTemp.source">
                    <option value="0">MQTT</option>
                    <option value="1">OT boiler</option>
                    <option value="2">Bluetooth</option>
                    <option value="3">1wire</option>
                    <option value="4">OpenWeather</option>
                </select>
                <div class="selopt">
                    <h5>Topic</h5>
                    <div class="statusfield statusvalue">
                        <span class="mqttbasetopic"></span><span>/outsideTemp/set</span>
                    </div>
                </div>
                <div class="selopt">
                </div>
                <div class="selopt">
                    <h5>Address</h5>
                    <input id="bleOutsideTempAdr" type="text" />
                </div>
                <div class="selopt">
                    <h5>address</h5>
                    <select id="oneWireOutsideTempAdr" class="oneWireAdr">
                    </select>
                </div>
                <div class="selopt">
                    <h5>API key</h5>
                    <input id="inpapikey" type="password" />
                    <h5>latitude</h5>
                    <input id="inplat" type="text" />
                    <h5>longitude</h5>
                    <input id="inplon" type="text" />
                    <h5>interval / s</h5>
                    <input id="inpinterval" type="text" />
                </div>
            </div>

            <h3>System</h3>
            <div class="group">
                <h4>Timezone</h4>
                <select id="selTimezone" field="timezone">
                    <option value="0">UTC</option>
                    <option value="3600">UTC + 1</option>
                    <option value="7200">UTC + 2</option>
                </select>
                
                <h4>Firmware</h4>
                <form id="form_upload" method='POST' enctype='multipart/form-data'>
                    <input id="inp_file" type='file' accept='.bin,.bin.gz' name='firmware'>
                    <input id="btn_upload" type='submit' value='upload'>
                    <div id="progressDiv" class="progress" hidden>
                        <div id="progressText"></div>
                        <progress id="updprogress" max="100" value="0"></progress>
                    </div>
                </form>
                <div>
                    <button id="checkbtn">Check for update</button>
                    <button id="installbtn" disabled>-</button>
                </div>
            </div>
        </div>
        <div class="tab" id="log">
            <div id="console">
            </div>
            <div id="logstatus"></div>
            <div class="toolbar">
                <button id="btnclearlog">clear log</button>
                <button id="btnsavelog">save log</button>
                <button id="btnautoscroll">autoscroll</button>
            </div>
        </div>
        <div class="toolbar">
            <button id="save">save</button>
            <button id="reboot">reboot</button>
        </div>
        <div class="footer"><a href="http://www.seegel-systeme.de" target="_blank">www.seegel-systeme.de</a></div>
    </div>
    <div id="dlgSlaveRequest" class="modal" hidden>
        <div class="modal-content">
            <div class="modal-header">
                <span>Slave request</span>
            </div>
            <pre id="modalBody"></pre>
            <div class="modal-footer">
                <button id="modalClose">close</button>
            </div>
        </div>
    </div>
    <script>
        var config = {
            hostname: "otthing",
            slaveApp: 0, // 0 = heat/cool, 1 = ventilation, 2 = solar storage
            otMode: 4,
            enableSlave: false,
            boiler: {
                dhwOn: true,
                dhwTemperature: 50,
                overrideDhw: false,
                coolOn: false,
                otc: false,
                summerMode: false,
                dhwBlocking: false,
                maxModulation: 100
            },
            heating: [
                {
                    flow: 45,
                    roomComp: {
                        enabled: false,
                        p: 1.5,
                        i: 0.5,
                        boost: 0
                    },
                    chOn: true,
                    flowMax: 60,
                    exponent: 1.3,
                    gradient: 1.0,
                    offset: 0,
                    marker: [],
                    roomsetpoint: {
                        source: 0,
                        temp: 21
                    },
                    roomtemp: {
                        source: 1
                    },
                    overrideFlow: false,
                    enableHyst: false,
                    hysteresis: 0.5
                },
                {
                    flow: 30,
                    roomComp: {
                        enabled: false,
                        p: 1.5,
                        i: 0.0,
                        boost: 0
                    },
                    chOn: false,
                    flowMax: 40,
                    exponent: 1.3,
                    gradient: 1.0,
                    offset: 0,
                    marker: [],
                    roomsetpoint: {
                        source: 0,
                        temp: 21
                    },
                    roomtemp: {
                        source: 1
                    },
                    overrideFlow: false,
                    enableHyst: false,
                    hysteresis: 0.5
                }
            ],
            vent: {
                ventEnable: false,
                openBypass: false,
                autoBypass: false,
                freeVentEnable: false,
                setpoint: 3
            },
            outsideTemp: {
                source: 0
            },
            mqtt: {
            },
            masterMemberId: 8
        },
        statuscache = {},
        roomsetpoint = [21, 21]; // used for drawing curve

        function _(query, root = document) {
            return root.querySelector(query);
        }

        function __(query, root = document) {
            return root.querySelectorAll(query);
        }

        function _$(elename, props = {}, ...children) {
            const result = document.createElement(elename);
            Object.assign(result, props);
            result.append(...children);
            return result;
        }

        window.onload = () => {
            __("div.nav li").forEach(li => {
                li.onclick = ev => {
                    __("div.nav li").forEach(x => x.classList.remove("active"));
                    __(".tab").forEach(x => x.hidden = true);

                    _(`#${li.getAttribute("tab")}`).hidden = false;
                    li.classList.add("active");
                };
            });
            _("div.nav li.active").click();

            let xhrSaveConfig = new XMLHttpRequest();
            //eventhandler for save button
            _("#save").onclick = () => {
                config.timezone = parseInt(_("#selTimezone").value);
                config.hostname = _("#hostname").value;
                config.haPrefix = _("#haPrefix").value;
                config.haName = _("#haName").value;
                config.slaveApp = parseInt(_("#slaveapp").value);
                config.enableSlave = _("#enableslave").checked;
                config.otMode = (_('input[name="otMode"]:checked') !== undefined) ? parseInt(_('input[name="otMode"]:checked').value) : null;
                config.outsideTemp = {
                    source: parseInt(_('#selectOutsideTempSource').value),
                    apikey: _("#inpapikey").value,
                    lat: parseFloat(_("#inplat").value),
                    lon: parseFloat(_("#inplon").value),
                    interval: parseInt(_("#inpinterval").value),
                };
                switch (config.outsideTemp.source) {
                case 2:
                    config.outsideTemp.adr = _("#bleOutsideTempAdr").value;
                    break;
                case 3:
                    config.outsideTemp.adr = _("#oneWireOutsideTempAdr").value;
                    break;
                }

                config.heating.forEach((heating, idx) => {
                    let ch = idx + 1;
                    heating.chOn = _(`#chOn${ch}`).checked;
                    heating.overrideFlow = _(`#overrideFlow${ch}`).checked;
                    heating.enableHyst = _(`#enableHyst${ch}`).checked;
                    delete heating.roomtemp["adr"];
                    switch (heating.roomtemp.source) {
                    case 2:
                        heating.roomtemp["adr"] = _(`#bleRoomTempAdr${ch}`).value;
                        break;
                    case 3:
                        heating.roomtemp["adr"] = _(`#oneWireRoomTempAdr${ch}`).value;
                        break;
                    }
                    heating.roomComp = {
                        ...(heating.roomComp ?? {}),
                        enabled: _(`#roomCompEnable${ch}`).checked
                    }
                });

                config.boiler = {
                    ...(config.boiler ?? {}),
                    dhwOn: _("#dhwOn").checked,
                    coolOn: _("#coolOn").checked,
                    overrideDhw: _("#overrideDhw").checked,
                    otc: _("#otc").checked,
                    summerMode: _("#summerMode").checked,
                    dhwBlocking: _("#dhwBlocking").checked
                };

                config.vent = {
                    ...(config.vent ?? {}),
                    ventEnable: _("#ventEnable").checked,
                    openBypass: _("#openBypass").checked,
                    autoBypass: _("#autoBypass").checked,
                    freeVentEnable: _("#freeVentEnable").checked
                };

                config.mqtt = {
                    host: _("#mqttHost").value,
                    port: parseInt(_("#mqttPort").value),
                    user: _("#mqttUser").value,
                    pass: _("#mqttPass").value,
                    tls: _("#mqttTls").checked,
                    keepAlive: parseInt(_("#mqttKeepAlive").value)
                };

                config.masterMemberId = parseInt(_("#masterMemberId").value);

                xhrSaveConfig.open("POST", "config");
                xhrSaveConfig.setRequestHeader("Content-Type", "application/json");
                xhrSaveConfig.send(JSON.stringify(config));
                xhrSaveConfig.onload = (ev) => {
                    alert("configuration saved successfully");
                };
            };

            //eventhandler for save button
            let xhrWiFiSet = new XMLHttpRequest();
            xhrWiFiSet.onload = (ev) => {
            };

            _("#btnsavewifi").onclick = (ev) => {
                xhrWiFiSet.open('POST', 'setwifi');
                xhrWiFiSet.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
                let params = "ssid=" + encodeURIComponent(_("#wifissid").value) + 
                        "&pass=" + encodeURIComponent(_("#wifipass").value); 
                xhrWiFiSet.send(params);
            };

            //eventhandler for add marker button
            _("#addmarker1").onclick = () => {
                addMarker(1);
            };
            //eventhandler for add marker button
            _("#addmarker2").onclick = () => {
                addMarker(2);
            };

            _("#addscheduler1").onclick = (ev) => {
                addScheduler(1);
            };

            // eventhandler for scan button
            _("#scan").onclick = (ev) => {
                _("#scanResults").hidden = true;
                _("#scanHint").hidden = false;
                _("#scanbody").innerHTML = "";
                scanWiFi();
            };

            _("#btnRequest").onclick = (ev) => {
                let id = 4; // ID remote request
                let rw = 0; // write
                let data = _("#selRequest").value;
                _("#modalBody").textContent = "Request running...";
                _("#dlgSlaveRequest").hidden = false;

                fetch(`/slaverequest?id=${id}&rw=${rw}&data=${data}`)
                    .then(r => {
                        if (!r.ok) throw new Error("HTTP " + r.status);
                        return r.json();
                    })
                    .then(resp => {
                        let rc = parseInt(resp["data"], 16) & 0xff;

                        if (rc >= 128)
                            _("#modalBody").innerHTML = "ACCEPTED<br>";
                        else
                            _("#modalBody").innerHTML = "REFUSED<br>";
                        
                        _("#modalBody").innerHTML += `<pre>${JSON.stringify(resp, null, 2)}</pre>`;
                    })
                    .catch(err => {
                        _("#modalBody").textContent = "Error:\n" + err.message;
                    });
            };
            _("#modalClose").onclick = (ev) => {
                _("#dlgSlaveRequest").hidden = true;
            }

            function addMarker(hk) {
                if (statuscache.outsideTemp == null) {
                    alert("No outside temperature available!");
                    return;
                }
                let heatCfg = config.heating[hk - 1];
                let ft = getFlowTemperature(
                    statuscache.outsideTemp, 
                    roomsetpoint[hk - 1], 
                    heatCfg.flowMax, 
                    heatCfg.exponent, 
                    heatCfg.gradient, 
                    heatCfg.offset
                );
                let comment = _("#comment" + hk).value;
                if (heatCfg.marker === undefined)
                    heatCfg.marker = [];
                heatCfg.marker.push({
                    comment: comment,
                    ot: statuscache.outsideTemp,
                    ft: Math.round(ft * 10) / 10,
                    rs: roomsetpoint[hk - 1]
                });
                _("#comment" + hk).value = "";
                drawMarkerTable(hk);
                drawCurve(hk);
            }

            function addScheduler(channel) {
                hcfg = config.heating[channel -1];
                if (!("scheduler" in hcfg))
                    hcfg["scheduler"] = [];
                hcfg.scheduler.push({
                    "days": [],
                    "time": "8:00",
                    "temp": 21
                });

                drawSchedulerTable(channel);
            }

            let xhrWiFiScan = new XMLHttpRequest();
            xhrWiFiScan.onload = (e) => {
                let scanObj = JSON.parse(e.target.responseText);
                if (scanObj.status < 0) {
                    setTimeout(scanWiFi, 1000);
                    return;
                }

                _("#scanResults").hidden= false;
                _("#scanHint").hidden = true;

                scanObj.results.forEach(element => {
                    _("#scanbody").append(
                        _$("tr", {},
                            _$("td", {},
                                _$("input", {
                                    type: "radio", 
                                    name: "ssid", 
                                    value: element.ssid, 
                                    onclick: (ev) => {_("#wifissid").value = ev.target.value;}
                                })
                            ),
                            _$("td", {textContent: element.ssid}),
                            _$("td", {textContent: element.channel}),
                            _$("td", {textContent: element.rssi})
                        )
                    );
                });
            };
            
            function scanWiFi() {
                xhrWiFiScan.open("GET", "scan");    
                xhrWiFiScan.send();
            }

            __("select").forEach((ele, index) => {
                ele.onchange = (ev) => {
                    var f = ele.getAttribute('field');
                    if (f == null)
                        return;
                    f = f.split('.');
                    val = config;
                    var i;
                    for (i=0; i<f.length-1; i++) {
                        if (!(f[i] in val))
                            val[f[i]] = {}
                        val = val[f[i]];
                    }
                    val[f[i]] = parseInt(ev.target.value);
                    ev.target.parentElement.querySelectorAll("div.selopt").forEach((ele, index) => {
                        ele.hidden = (index != ev.target.selectedIndex);
                    });
                }
            });

            _("#selectOutsideTempSource").addEventListener("change", (ev) => {
                _("#owdiv").hidden = (ev.target.value != 4);
            });

            _("#slaveapp").onchange = (ev) => {
                let app = parseInt(ev.target.value);
                for (const ele of __(".app-heat"))
                    ele.hidden = (app != 0);
                for (const ele of __(".app-vent"))
                    ele.hidden = (app != 1);
            }

            __('input[type="checkbox"][hideele]').forEach(cb => {
                cb.addEventListener("change", () => {
                    const ids = cb.getAttribute("hideele").split(/\s+/);
                    ids.forEach(id => {
                        const el = _(`#${id}`);
                        if (el)
                            el.hidden = !cb.checked;
                    });
                })
            });

            function drawMarkerTable(hk) {
                if (hk === undefined) {
                    drawMarkerTable(1);
                    drawMarkerTable(2);
                    return;
                }
                _("#markerbody" + hk).innerHTML = "";
                
                var i = 0;
                config.heating[hk - 1].marker?.forEach(function (item) {
                    _(`#markerbody${hk}`).append(
                        _$("tr", {}, 
                            _$("td", {textContent: item.comment}),
                            _$("td", {textContent: (item.rs || "-") + " °C"}),
                            _$("td", {textContent: item.ot + " °C"}),
                            _$("td", {textContent: item.ft + " °C"}),
                            _$("td", {},
                                _$("button", {
                                    className: "rmmarker", 
                                    textContent: "-",
                                    onclick: (ev) => {
                                        config.heating[hk - 1].marker.splice(ev.target.getAttribute("index"), 1);
                                        drawMarkerTable(hk);
                                        drawCurve(hk);
                                    }
                                })
                            )
                        )
                    );

                    _(`#markerbody${hk} tr:last-child button`).setAttribute("index", i++);
                });
            }

            function drawSchedulerTable(channel) {
                if (channel === undefined) {
                    drawSchedulerTable(1);
                    drawSchedulerTable(2);
                    return;
                }
                _("#schedulerbody" + channel).innerHTML = "";
                
                var i = 0;
                config.heating[channel - 1].scheduler.forEach(function (item) {
                    _(`#schedulerbody${channel}`).append(
                        _$("tr", {}, 
                            _$("td", {}),
                            _$("td", {textContent: item.time}),
                            _$("td", {textContent: item.temp + " °C"}),
                            _$("td", {},
                                _$("button", {
                                    className: "rmscheduler", 
                                    textContent: "-",
                                    onclick: (ev) => {
                                        config.heating[channel - 1].scheduler.splice(ev.target.getAttribute("index"), 1);
                                        drawSchedulerTable(channel);
                                    }
                                })
                            )
                        )
                    );

                    _(`#schedulerbody${channel} tr:last-child button`).setAttribute("index", i++);
                });
            }

            function setParam(name, val) {
                var slider = _('#' + name + " input[type=range]");
                if (val !== undefined)
                    slider.value = val;
                else
                    val = "?";
                _("#" + name + " span.value").innerHTML = val;
            }

            function initRangeParam(name, configPath) {
                var cfgVal = config;
                let p = configPath.split('.');
                for (var i=0, len = p.length; i<len; i++) {
                    if ( (cfgVal[p[i]] === undefined) && (i<len-1) )
                        cfgVal[p[i]] = {};
                    cfgVal = cfgVal[p[i]];
                };

                setParam(name, cfgVal);

                var slider = _('#' + name + " input[type=range]");
                var path = configPath;
                slider.addEventListener("input", (ev) => {
                    setParam(name, ev.target.value);

                    var cfgVal = config;
                    var p = path.split('.')
                    for (var i=0, len = p.length; i<len; i++) {
                        if (i<len-1) {
                            cfgVal = cfgVal[p[i]];
                        }
                        else
                            cfgVal[p[i]] = parseFloat(ev.target.value);
                    };
                    drawCurve();
                });
            }

            let xhrConfig = new XMLHttpRequest();
            xhrConfig.onload = (ev) => {
                try {
                    config = JSON.parse(ev.target.responseText);
                }
                catch (err) {
                }
                configToUi();
            };
            xhrConfig.onerror = (ev) => {
                configToUi();
            };
            xhrConfig.open("GET", "config");
            xhrConfig.send();
            function configToUi() {
                _("#hostname").value = config.hostname || "otthing";
                _("#haPrefix").value = config.haPrefix || "homeassistant";
                _("#selTimezone").value = config.timezone || 3600;
                _("#haName").value = config.haName || "OTthing";
                let otradio = _('input[name="otMode"][value="' + config.otMode + '"]');
                if (otradio !== undefined) {
                    otradio.checked = true;
                    otradio.dispatchEvent(new Event('click'));
                }

                _("#slaveapp").value = config.slaveApp || 0;
                _("#slaveapp").dispatchEvent(new Event('change'));
                _("#enableslave").checked = config.enableSlave || false;

                _("#masterMemberId").value = config.masterMemberId || 8;

                _("#selectOutsideTempSource").value = config.outsideTemp.source;
                _("#selectOutsideTempSource").dispatchEvent(new Event('change'));
                _("#inpapikey").value = config.outsideTemp.apikey || null;
                _("#inplat").value = config.outsideTemp.lat || null;
                _("#inplon").value = config.outsideTemp.lon || null;
                _("#inpinterval").value = config.outsideTemp.interval || null;
                _("#oneWireOutsideTempAdr").value = config.outsideTemp.adr || "";

                _("#mqttHost").value = config.mqtt.host || null;
                _("#mqttPort").value = config.mqtt.port || 1883;
                _("#mqttTls").checked = config.mqtt.tls || false;
                _("#mqttUser").value = config.mqtt.user || null;
                _("#mqttPass").value = config.mqtt.pass || null;
                _("#mqttKeepAlive").value = config.mqtt.keepAlive || 15;

                _("#dhwOn").checked = config.boiler.dhwOn;
                _("#coolOn").checked = config.boiler.coolOn;
                _("#overrideDhw").checked = config.boiler.overrideDhw;
                initRangeParam("dhwtemp", "boiler.dhwTemperature");
                initRangeParam("maxModulation", "boiler.maxModulation");

                _("#otc").checked = config.boiler.otc;
                _("#summerMode").checked = config.boiler.summerMode;
                _("#dhwBlocking").checked = config.boiler.dhwBlocking;

                if (config.heating === undefined)
                    config.heating = [{}, {}];

                config.heating.forEach((hcfg, idx) => {
                    let ch = idx + 1;

                    _(`#chOn${ch}`).checked = hcfg.chOn || false;
                    _(`#overrideFlow${ch}`).checked = hcfg.overrideFlow || false;
                    _(`#roomset${ch}`).addEventListener("input", (ev) => {
                        roomsetpoint[idx] = parseFloat(ev.target.value);
                    });
                    _(`#enableHyst${ch}`).checked = hcfg.enableHyst || false;
                    _(`#roomCompEnable${ch}`).checked = hcfg.roomComp?.enabled || false;

                    initRangeParam(`chset${ch}`, `heating.${idx}.flow`);
                    initRangeParam(`roomset${ch}`, `heating.${idx}.roomsetpoint.temp`);
                    initRangeParam(`flowmax${ch}`, `heating.${idx}.flowMax`);
                    initRangeParam(`exponent${ch}`, `heating.${idx}.exponent`);
                    initRangeParam(`gradient${ch}`, `heating.${idx}.gradient`);
                    initRangeParam(`offset${ch}`, `heating.${idx}.offset`);
                    initRangeParam(`roomCompP${ch}`, `heating.${idx}.roomComp.p`);
                    initRangeParam(`roomCompI${ch}`, `heating.${idx}.roomComp.i`);
                    initRangeParam(`roomCompBoost${ch}`, `heating.${idx}.roomComp.boost`);
                    initRangeParam(`hyst${ch}`, `heating.${idx}.hysteresis`);

                     if ('roomtemp' in hcfg) {
                        _(`#selectRoomTempSource${ch}`).value = hcfg.roomtemp.source;
                        if (hcfg.roomtemp.source == 2)
                            _(`#bleRoomTempAdr${ch}`).value = hcfg.roomtemp.adr;
                     }
                    _(`#selectRoomTempSource${ch}`).dispatchEvent(new Event('change'));

                    if ('roomsetpoint' in hcfg)
                        _(`#selectRoomSetpointSource${ch}`).value = hcfg.roomsetpoint.source;
                    _(`#selectRoomSetpointSource${ch}`).dispatchEvent(new Event('change'));
                });

                _("#ventEnable").checked = config.vent?.ventEnable ?? false;
                _("#openBypass").checked = config.vent?.openBypass ?? false;
                _("#autoBypass").checked = config.vent?.autoBypass ?? false;
                _("#freeVentEnable").checked = config.vent?.freeVentEnable ?? false;

                initRangeParam("ventsetpoint", "vent.setpoint");
                drawMarkerTable();
                drawCurve();
                __('input[type="checkbox"][hideele]').forEach(cb => {
                    cb.dispatchEvent(new Event("change"));
                });
            }

            var xhrStatus = new XMLHttpRequest();
            xhrStatus.timeout = 3000;
            xhrStatus.onload = (ev) => {
                try {
                    statuscache = JSON.parse(ev.target.responseText);
                }
                catch (err) {
                }

                _("#nocon").hidden = true;

                let rtstr = "";
                let runtime = statuscache.runtime;
                rtstr = (runtime % 60) + " s";
                runtime = Math.floor(runtime / 60);
                if (runtime > 0) {
                    rtstr = (runtime % 60) + " m, " + rtstr;
                    runtime = Math.floor(runtime / 60);
                    if (runtime > 0) {
                        rtstr = (runtime % 24) + " h, " + rtstr;
                        runtime = Math.floor(runtime / 24);
                        if (runtime > 0) {
                            rtstr = runtime + " d, " + rtstr;
                        }
                    }
                }
                _("#runtime").innerText = rtstr;

                if (statuscache.slave?.slave_config_member?.dhw_present === false) {
                    __(".DHW").forEach(ele => {
                        ele.hidden = true;
                    });
                }

                if (statuscache.slave?.slave_config_member?.ch2_present === false) {
                    __(".CH2").forEach(ele => {
                        ele.hidden = true;
                    });
                }

                if (statuscache.slave?.slave_config_member?.cooling_config === false) {
                    __(".cool").forEach(ele => {
                        ele.hidden = true;
                    });
                }

                if ('new_fw' in statuscache) {
                    if (statuscache['new_fw'] == "") {
                        _("#installbtn").disabled = true;
                        _("#installbtn").innerText = "no update";
                        _("#checkbtn").disabled = false;
                    }
                    else {
                        _("#installbtn").disabled = false;
                        _("#installbtn").innerText = "install " + statuscache['new_fw'];
                    }
                }

                __(".statusvalue").forEach((ele) => {
                    var val = null;
                    if (!ele.hasAttribute('field'))
                        return;
                    try {
                        var f = ele.getAttribute('field').split('.');
                        val = statuscache;
                        for (var i=0; i<f.length; i++)
                            val = val[f[i]];
                        
                        if ((val !== null) && (val !== undefined)) {
                            const isErr = ele.classList.contains("error");
                            if (val === true) {
                                ele.classList.add(isErr ? "bool-error" : "bool-ok");
                                ele.classList.remove(isErr ? "bool-ok" :"bool-off");
                            }
                            else if (val === false) {
                                ele.classList.add(isErr ? "bool-ok" : "bool-off");
                                ele.classList.remove(isErr ? "bool-error" : "bool-on");
                            }
                            else
                                ele.textContent = val;
                        }
                        else
                            ele.textContent = "---";
                        
                        if (ele.hasAttribute('unit'))
                            ele.textContent += ' ' + ele.getAttribute('unit');
                    }
                    catch (ex) {
                        val = null;
                    }

                    if ( ((val !== null) && (val !== undefined)) || ele.classList.contains("nohide") )
                        ele.parentElement.hidden = false;
                    else
                        ele.parentElement.hidden = true;
                });

                __(".mqttbasetopic").forEach((ele) => {
                    ele.innerHTML = statuscache.mqtt.basetopic;
                });

                if ("1wire" in statuscache) {
                    __(".oneWireAdr").forEach((ele) => {
                        if (ele.childElementCount == 0) {
                            for (adr in statuscache["1wire"])
                                ele.append(_$("option", {textContent: adr}));

                            if ( (ele == _("#oneWireRoomTempAdr1")) && (config.heating[0].roomtemp.source == 3) )
                                ele.value = config.heating[0].roomtemp.adr;

                            else if ( (ele == _("#oneWireRoomTempAdr2")) && (config.heating[1].roomtemp.source == 3) )
                                ele.value = config.heating[1].roomtemp.adr;

                            else if ( (ele == _("#oneWireOutsideTempAdr")) && (config.outsideTemp.source == 3) )
                                ele.value = config.outsideTemp.adr;
                        }
                    });

                    var i = 1;
                    for (adr in statuscache["1wire"]) {
                        if (_("#oneWireSensors").childElementCount < Object.keys(statuscache["1wire"]).length) {
                            _("#oneWireSensors").append(
                                _$("div", {className: "statusfield"},
                                    _$("h5", {textContent: adr}),
                                    _$("span", {className: "statusvalue"})
                                )
                            );
                        }
                        _("#oneWireSensors div:nth-child(" + i + ") span").innerText = statuscache["1wire"][adr] + " °C";
                        i++;
                    }
                }

                if ("BLE" in statuscache) {
                    let i = 0;
                    for (adr in statuscache["BLE"]) {
                        if (__("#bleSensors>div").length < Object.keys(statuscache["BLE"]).length) {
                            _("#bleSensors").append(
                                _$("h4", {textContent: adr}),
                                _$("div", {className: "flexline"},
                                    _$("div", {className: "statusfield"},
                                        _$("h5", {textContent: "temperature"}),
                                        _$("span", {className: "statusvalue"})
                                    ),
                                    _$("div", {className: "statusfield"},
                                        _$("h5", {textContent: "humidity"}),
                                        _$("span", {className: "statusvalue"})
                                    ),
                                    _$("div", {className: "statusfield"},
                                        _$("h5", {textContent: "battery"}),
                                        _$("span", {className: "statusvalue"})
                                    ),
                                    _$("div", {className: "statusfield"},
                                        _$("h5", {textContent: "RSSI"}),
                                        _$("span", {className: "statusvalue"})
                                    )
                                )
                            );
                        }
                        __("span", __("#bleSensors div.flexline")[i])[0].innerText = statuscache["BLE"][adr]["temp"] + " °C";
                        __("span", __("#bleSensors div.flexline")[i])[1].innerText = statuscache["BLE"][adr]["rh"] + " %";
                        __("span", __("#bleSensors div.flexline")[i])[2].innerText = statuscache["BLE"][adr]["bat"] + " %";
                        __("span", __("#bleSensors div.flexline")[i])[3].innerText = statuscache["BLE"][adr]["rssi"] + " dBm";
                        i++;
                    }
                }

                if ("heatercircuit" in statuscache) {
                    for (let i=0; i<2; i++)
                        if ("roomsetpoint" in statuscache.heatercircuit[i])
                            roomsetpoint[i] = statuscache.heatercircuit[i].roomsetpoint;
                }
                
                drawCurve();
                setTimeout(fetchStatus, 5000);
            };
            xhrStatus.ontimeout = (ev) => {
                _("#nocon").hidden = false;
                setTimeout(fetchStatus, 10000);
            };

            function fetchStatus() {
                xhrStatus.open("GET", "status");
                xhrStatus.send();
            }
            fetchStatus();
            drawCurve();

            _("#reboot").onclick = (ev) => {
                let xhr = new XMLHttpRequest();
                xhr.open("GET", "/reboot");
                xhr.send("");
            };

            var xhrUpl = new XMLHttpRequest();
            _("#form_upload").onsubmit = (ev) =>{
                ev.preventDefault();

                var file = _("#inp_file").files[0];
                var formdata = new FormData();
                formdata.append(_("#inp_file").name, file, file.name);
                
                xhrUpl.upload.onprogress = (ev) => {
                    var perc = Math.round(ev.loaded / ev.total * 100);
                    _("#updprogress").value = perc;
                    _("#updprogress").innerText = perc + ' %';
                    _("#progressText").innerHTML = "Uploading...";
                };

                xhrUpl.onload = () => {
                    _("#inp_file").value = "";
                    _("#progressText").innerHTML = "Upload successful. Rebooting...";
                    setTimeout(() => {
                        location.reload();
                    }), "5000";
                };

                xhrUpl.onloadstart = () => {
                    _("#progressDiv").hidden = false;
                    _("#btn_upload").disabled = true;
                    _("#inp_file").disabled = true;
                };

                xhrUpl.onerror = () => {
                    _("#progressText").innerHTML = "Error: " + ajaxUpl.status;
                };

                xhrUpl.open('post', '/update');
                xhrUpl.setRequestHeader('Access-Control-Allow-Headers', '*');
                xhrUpl.setRequestHeader('Access-Control-Allow-Origin', '*');
                xhrUpl.send(formdata);
            };

            _("#checkbtn").onclick = (ev) => {
                let xhrCheck = new XMLHttpRequest;
                xhrCheck.open('post', '/checkupdate');
                _("#checkbtn").disabled = true;
                _("#installbtn").innerText = "checking...";
                _("#installbtn").disabled = true;
                xhrCheck.send('');
            };

            _("#installbtn").onclick = (ev) => {
                let xhrInstall = new XMLHttpRequest;
                _("#installbtn").disabled = true;
                _("#installbtn").innerText = "installing...";
                xhrInstall.open('post', '/install');
                xhrInstall.send('');
            };

            let otModeItems = __('input[name="otMode"]');
            otModeItems.forEach(function (item) {
                item.onclick = (ev) => {
                    __('.otmode-repeater, .otmode-master, .otmode-test').forEach(function(ele) {
                        ele.hidden = true;
                    });
                    switch (parseInt(item.value)) {
                        case 1:
                            // show elements for master mode
                            __('.otmode-master').forEach(function(ele) {
                                 ele.hidden = false;
                            });
                            break;
                        case 2:
                            // show elements for repeater mode
                            __('.otmode-repeater').forEach(function(ele) {
                                 ele.hidden = false;
                            });
                            break;
                        default:
                            break;
                    }                    
                }
            });

            function connectWS() {
                function logws(msg) {
                    let e = _$("div");
                    e.innerHTML = msg;
                    let cons = _("#console");
                    cons.append(e);
                    if (!_("#btnautoscroll").classList.contains("pressed"))
                        cons.scrollTop = cons.scrollHeight;
                }

                var websocket = new WebSocket("ws");
                websocket.onopen = (ev) => {
                    _("#logstatus").classList.add('connected');
                    _("#logstatus").classList.remove('disconnected');
                }
                websocket.onclose = (ev) => {
                    _("#logstatus").classList.add('disconnected');
                    _("#logstatus").classList.remove('connected');
                    setTimeout(function() {
                        connectWS();
                    }, 1000);
                }
                websocket.onmessage = (ev) => {
                    logws(ev.data);
                }
                websocket.onerror = (ev) => {
                    logws("Error");
                    websocket.close();
                }
            }
            connectWS();

            _("#btnclearlog").onclick = (ev) => {
                _("#console").innerHTML = "";
            };

            _("#btnsavelog").onclick = (ev) => {
                let logContent = "";
                _("#console").childNodes.forEach((child) => {
                    if (child.textContent) {
                        logContent += child.textContent + "\n";
                    }
                });
                let blob = new Blob([logContent], { type: "text/plain" });
                let url = URL.createObjectURL(blob);
                let link = document.createElement("a");
                link.href = url;
                link.download = "log_otthing.txt";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            };

            _("#btnautoscroll").onclick = (ev) => {
                ev.target.classList.toggle("pressed");
            }
        };

        function getMinOutsideTemp(rs, mf, g) {
            return rs - (mf - rs) / g; //minimal outside temperature at mf
        }

        /*
            ot: outside temperature
            rs: room set temperature
            mf: max. flow temperature
            n: heating exponent
            g: gradient
            s: shift
        */
        function getFlowTemperature(ot, rs, mf, n, g, s) {
            let am = getMinOutsideTemp(rs, mf, g);
            //calculate c1
            let c1 = (mf - rs) / ((rs - am) ** (1.0 / n));
            return rs + c1 * (rs - ot) ** (1.0 / n) + s;
        }

        function drawCurve(hk) {
            if (hk === undefined) {
                drawCurve(1);
                drawCurve(2);
                return;
            }
            var canvas = document.getElementById(`canvas${hk}`);
            let flowmax = parseFloat(_("#flowmax" + hk + " input").value);
            let fmg = Math.ceil(flowmax / 10) * 10 + 5; // flowmax for graph

            canvas.height = 20 + (fmg - 20) * 4.5;
            var ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            let origin = {
                x: 20,
                y: canvas.height - 20
            };
            let xaxis = {
                min: 20, // °C
                max: -20, // °C
                step: 5,
                zoom: (canvas.width - origin.x * 2) / (20 - (-20))
            };
            let yaxis = {
                min: 20, // °C
                max: fmg, // °C
                step: 10,
                zoom: (canvas.height - (canvas.height - origin.y) * 2) / (fmg - 20)
            };

            ctx.lineWidth = 1;
            ctx.strokeStyle = "#666";
            ctx.fillStyle = "#FFF";
            ctx.textBaseline = "middle";
            ctx.textAlign = "center";
            ctx.font = '11px sans-serif';

            //draw horizontal grid
            ctx.beginPath();
            for (var i = yaxis.min; i <= yaxis.max; i += yaxis.step) {
                let y = origin.y - (i - yaxis.min) * yaxis.zoom;
                ctx.moveTo(origin.x, y);
                ctx.lineTo(origin.x + (xaxis.min - xaxis.max) * xaxis.zoom, y);
                ctx.fillText(i, origin.x - 10, y);
            }
            ctx.stroke();
            ctx.strokeStyle = "#333";
            ctx.beginPath();
            for (var i = yaxis.min + yaxis.step / 2; i <= yaxis.max; i += yaxis.step) {
                let y = origin.y - (i - yaxis.min) * yaxis.zoom;
                ctx.moveTo(origin.x, y);
                ctx.lineTo(origin.x + (xaxis.min - xaxis.max) * xaxis.zoom, y);
            }
            ctx.stroke();

            ctx.strokeStyle = "#666";
            //draw vertical grid
            ctx.beginPath();
            for (var i = xaxis.min; i >= xaxis.max; i -= xaxis.step) {
                let x = origin.x + (xaxis.min - i) * xaxis.zoom;
                ctx.moveTo(x, origin.y);
                ctx.lineTo(x, origin.y - (yaxis.max - yaxis.min) * yaxis.zoom);
                ctx.fillText(i, x, origin.y + 10);
            }
            ctx.stroke();
            ctx.strokeStyle = "#333";
            ctx.beginPath();
            for (var i = xaxis.min - xaxis.step / 2; i >= xaxis.max; i -= xaxis.step) {
                let x = origin.x + (xaxis.min - i) * xaxis.zoom;
                ctx.moveTo(x, origin.y);
                ctx.lineTo(x, origin.y - (yaxis.max - yaxis.min) * yaxis.zoom);
                ctx.stroke();
            }
            ctx.stroke();

            ctx.lineWidth = 2;
            ctx.strokeStyle = "#fff";

            //draw x-axis
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x + (xaxis.min - xaxis.max) * xaxis.zoom, origin.y);
            ctx.stroke();
            ctx.fillText("outside / °C", canvas.width - 55, origin.y - 10);

            //draw y-axis
            ctx.beginPath();
            ctx.moveTo(origin.x, origin.y);
            ctx.lineTo(origin.x, origin.y - (yaxis.max - yaxis.min) * yaxis.zoom);
            ctx.stroke();
            ctx.save();
            ctx.rotate(-Math.PI / 2);
            ctx.fillText("flow / °C", -47, 30);
            ctx.restore();

            let roomset = roomsetpoint[hk - 1];
            let roomdelta = 0;
            let rc = config.heating?.[hk-1]?.roomComp;
            if (rc?.enabled === true) {
                const hcs = statuscache?.heatercircuit?.[hk - 1];
                if (hcs?.roomtemp !== undefined)
                    roomdelta = (rc.p ?? 0) * (roomset - (hcs.roomtemp ?? 0)) + hcs.integState ?? 0;
            }

            let gradient = parseFloat(_("#gradient" + hk + " input").value);
            let exponent = parseFloat(_("#exponent" + hk + " input").value);
            let offset = parseFloat(_("#offset" + hk + " input").value);

            function getPoint(ot, ft) {
                return {
                    x: origin.x + (xaxis.min - ot) * xaxis.zoom,
                    y: origin.y - (ft - yaxis.min) * yaxis.zoom
                }
            }

            function drawMarkerPoint(p, color) {
                ctx.fillStyle = color;
                ctx.fillRect(p.x - 3, p.y - 3, 6, 6);    
            }

            let otStart = Math.min(roomset, xaxis.min);
            let ft = getFlowTemperature(otStart, roomset, flowmax, exponent, gradient, offset);
            let p1 = getPoint(otStart, ft); //foot

            drawMarkerPoint(p1, '#A33');

            function drawFlowCurve(color, delta) {
                ctx.strokeStyle = color;
                ctx.lineWidth = 3;
                let ft = getFlowTemperature(otStart, roomset, flowmax, exponent, gradient, offset) + delta;
                let p = getPoint(otStart, ft);
                ctx.beginPath();
                ctx.moveTo(p.x, p.y);
                let otf = false;
                for (var ot = otStart; ot >= xaxis.max; ot -= 0.5) {
                    ft = getFlowTemperature(ot, roomset, flowmax, exponent, gradient, offset) + delta;

                    if ((ft >= flowmax) && !otf) {
                        ctx.stroke();
                        ctx.strokeStyle = "#888";
                        ctx.beginPath();
                        ctx.moveTo(p.x, p.y);
                        otf = true;
                    }

                    p = getPoint(ot, ft);
                    ctx.lineTo(p.x, p.y);

                    if (ft >= yaxis.max)
                        break;
                }
                ctx.stroke();
            }
            drawFlowCurve("#F00", 0);
            if (roomdelta != 0)
                drawFlowCurve("#0F0", roomdelta);

            //draw curve's basepoint
            drawMarkerPoint(p1, '#F00');

            if (statuscache.outsideTemp !== undefined) {
                //draw outsidetemp & it's flowtemperature
                let ftsensor = getFlowTemperature(statuscache.outsideTemp, roomset, flowmax, exponent, gradient, offset) + roomdelta;
                if (ftsensor > flowmax)
                    ftsensor = flowmax;
                let psensor = getPoint(statuscache.outsideTemp, ftsensor);
                drawMarkerPoint(psensor, '#F83');
                ctx.strokeStyle = "#F83";
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(origin.x, psensor.y);
                ctx.lineTo(psensor.x, psensor.y);
                ctx.lineTo(psensor.x, origin.y);
                ctx.stroke();
                ctx.fillText(Math.round(ftsensor * 10) / 10, origin.x + 30, psensor.y - 8);
            }

            //draw markers
            config.heating[hk - 1].marker?.forEach(function (m) {
                drawMarkerPoint(getPoint(m.ot, m.ft), '#3f8');
            });

            // draw current flow temp
            let flow = (hk == 1) ? statuscache.slave?.flow_t : statuscache.slave?.flow_t2;
            if (flow !== undefined && flow !== null) {
                let pf = getPoint(xaxis.min, (hk == 1) ? statuscache?.slave.flow_t : statuscache?.slave.flow_t2);
                let flame = statuscache.slave?.status?.flame;
                ctx.fillStyle = (flame === true) ? "#fa0" : "#13f";
                ctx.strokeStyle = "#000";
                ctx.beginPath();
                ctx.moveTo(pf.x - 4 , pf.y);
                ctx.lineTo(pf.x + 5, pf.y + 4);
                ctx.lineTo(pf.x + 5, pf.y - 4);
                ctx.closePath();
                ctx.stroke();
                ctx.fill();
            }
        }
    </script>
</body>
</html>